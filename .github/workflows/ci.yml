name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - name: Install dependencies
        run: npm install
      - name: Lint
        run: npx eslint src/pages/ src/public/ --fix
      - name: Prettier
        run: npx prettier --write src/pages/ src/public/
      - name: Test
        run: |
          if [ -f package.json ] && grep -q '"test"' package.json; then
            npm run test
          else
            echo "No test script defined. Skipping tests."
          fi
      - name: Check for _headers file
        run: |
          if [ ! -f _headers ]; then
            echo "ERROR: _headers file missing at repo root!" && exit 1
          fi
      - name: Check HTML files for <link> and <script> in <head>
        run: |
          missing=""
          for f in $(find . -type f -name '*.html'); do
            if ! grep -q '<link rel="stylesheet"' "$f" || ! grep -q 'window.addEventListener' "$f"; then
              echo "Missing <link> or <script> in $f"; missing=1
            fi
          done
          if [ "$missing" = "1" ]; then exit 1; fi
