name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - name: Install dependencies
        run: npm install
      - name: Lint
        run: npx eslint src/pages/ src/public/ --fix
      - name: Prettier
        run: npx prettier --write src/pages/ src/public/
      - name: Test
        run: |
          if [ -f package.json ] && grep -q '"test"' package.json; then
            npm run test
          else
            echo "No test script defined. Skipping tests."
          fi
      - name: Check HTML files for <link> and <script> in <head>
        run: |
          missing=""
          for f in $(find . -type f -name '*.html'); do
            if ! grep -q '<link rel="stylesheet"' "$f" || ! grep -q 'window.addEventListener' "$f"; then
              echo "Missing <link> or <script> in $f"; missing=1
            fi
          done
          if [ "$missing" = "1" ]; then exit 1; fi
      - name: Check public HTML CORS headers and status
        run: |
          echo "| Page | Status | CORS Header | Notes |" > summary.md
          echo "|------|--------|-------------|-------|" >> summary.md
          failed=0
          for file in public/*.html; do
            name=$(basename "$file")
            url="https://www.macrosight.net/$name"
            status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            cors=$(curl -sI "$url" | grep -i "access-control-allow-origin")
            if [ "$status" -ne 200 ]; then
              echo "| $name | $status | ❌ | Not Found or Error |" >> summary.md
              failed=1
            elif [ -z "$cors" ]; then
              echo "| $name | $status | ❌ | No CORS Header |" >> summary.md
              failed=1
            else
              echo "| $name | $status | ✅ | OK |" >> summary.md
            fi
          done
          cat summary.md
          if [ "$failed" -eq 1 ]; then
            echo "❌ Some HTML files are missing or lack CORS headers"
            exit 1
          fi
